<!DOCTYPE HTML>
<!--
	Editorial by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
<head>
    <title>Models and Physics</title>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
    <!--[if lte IE 8]>
    <script src="../../assets/js/ie/html5shiv.js"></script><![endif]-->
    <link rel="stylesheet" href="../../assets/css/main.css"/>
    <!--[if lte IE 9]>
    <link rel="stylesheet" href="../../assets/css/ie9.css"/><![endif]-->
    <!--[if lte IE 8]>
    <link rel="stylesheet" href="../../assets/css/ie8.css"/><![endif]-->

    <!--Code Syntax Highlighting JS library-->
    <link rel="stylesheet" href="../../assets/css/xcode.css"/>
    <script src="../../assets/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

</head>
<body>

<!-- Wrapper -->
<div id="wrapper">

    <!-- Main -->
    <div id="main">
        <div class="inner">

            <!-- Header -->
            <header id="header">
                <h2><a href="" class="logo">Tutorial: SceneKit Models and Physics</a></h2>
            </header>

            <br />
            <p>Note: This application builds on concepts learned in the <a href="../arkit-hello-world/tutorial.html">ARKit Hello World tutorial</a>.</p>

            <br />
            <h3>Learning Objectives</h3>
            <ul>
                <li>How to perform a hit test to determine plane collision</li>
                <li>How to render a 3D SceneKit model in ARKit</li>
                <li>How to apply physics to SceneKit models</li>
            </ul>

            <h3>Foreword: Software Life Cycle</h3>
            <p>Even with smaller applications, the <a
                    href="https://manta.cs.vt.edu/cs3714/StudentsOnly/Handouts/SELifeCycle.html" target="_blank">software
                life cycle</a> is crucial to developing and maintaining high-quality software. This tutorial encompasses only the <i>programming</i>
                process of the cycle.</p>

            <h3>Application Functionality</h3>
            <p>This is a universal application that will run on iPhone 6s and up and iPad Pro and up.</p>
            <p>The tutorial teaches how to create a 3D SceneKit model, render it in augmented reality, and apply physics to the object in real time.</p>


            <h3>Creating the project</h3>
            <p>This project requires Xcode 9.0 and above.</p>
            <ol>
                <li>Launch Xcode and select <b>Create a new Xcode project</b> from the Xcode welcome screen, or select
                    <b>File
                        → New → Project...</b></li>
                <li>Choose <b> iOS → Application → Augmented Reality App</b> and click next.<br><img
                        src="../common-images/application-type-selection.png" width="70%"/></li>
                <li>In the <i>Choose options for your new project</i> dialog, choose <b>SceneKit</b> as the <i>Content
                    Technology</i><img
                        src="../common-images/scenekit.png" width="70%"/></li>
            </ol>

            <h3>Configuring Your Environment</h3>
            <p>Creating a new ARKit project generates a sample application, so some cleanup is required.</p>
            <ol>
                <li>In ViewController.swift, delete the sample code from <code>viewDidLoad()</code>.<br><img
                        src="../common-images/viewDidLoad.png" width="70%"/></li>
                <li>Delete everything inside the art.scnassets folder. <br><img src="../common-images/art.png" width="70%"/></li>
            </ol>

            <p>Create a new AR Session using the technique learned in the <a href="../arkit-hello-world/tutorial.html">ARKit Hello World tutorial</a>. Follow the tutorial steps in order to start dynamically tracking horizontal planes. The rest of the tutorial assumes you have followed these steps.</p>

            <h3>Performing a Hit Test</h3>
            <p>When the user taps the screen in an AR application, ARKit records the 2D coordinates of the touch. In order to convert the 2D coordinates of the touch to real-world 3D coordinates, ARKit performs a "hit test." This test works as if the user's touch had fired a vector from the device's camera's origin through a 3D point created by projecting the 2D touch point into the 3D view. This 3D point is recorded.</p>
            <p>If the 3D point lies on a detected horizontal plane, the hit test is a success. In this tutorial, we will use hit testing to allow the user to place 3D cubes in AR.</p>
            <p>To create a hit test routine, first create a Tap Gesture Recognizer by opening your Main.storyboard and searching the Object library. Drag the Tap Gesture Recognizer object into your ViewController's Scene View. Your View Controller Scene should now look like this:</p>
            <img src="images/tap-gesture-recognizer.png" />
            <p>Next, open the Assistant Editor to your Main.storyboard and your ViewController.swift. Implement an action method that will be called when the Tap Gesture Recognizer is recognized.</p>
            <p>Copy the documented code given below. <b>Carefully study the code, understand what it is doing, and learn from it!</b></p>
            <pre><code>
// MARK: - Gesture Handling Action methods

@IBAction func userTappedScreen(_ sender: UITapGestureRecognizer) {
    // Get the 2D point of the touch in the SceneView
    let tapPoint: CGPoint = sender.location(in: self.sceneView)

    // Conduct the hit test on the SceneView
    let hitTestResults: [ARHitTestResult] = sceneView.hitTest(tapPoint, types: .existingPlaneUsingExtent)

    if hitTestResults.isEmpty {
        return
    }

    // Arbitrarily pick the closest plane in the case of multiple results
    let result: ARHitTestResult = hitTestResults[0]

    // The position of the ARHitTestResult relative to the world coordinate system
    // The 3rd column in the matrix corresponds the the position of the point in the coordinate system
    let resultPositionMatrixColumn = result.worldTransform.columns.3

    // Position the node slightly above the hit test's position in order to show off gravity later
    let targetPosition: SCNVector3 = SCNVector3Make(resultPositionMatrixColumn.x, resultPositionMatrixColumn.y + /* insertion offset of ~50 cm */ 0.5, resultPositionMatrixColumn.z)

    // This method is implemented in the next section of the tutorial.
    addCubeAt(targetPosition)
}
            </code></pre>
            <p>Connect your action method to the gesture recognizer by holding the control key and dragging from the Tap Gesture Recognizer to your action method.</p>
            <h3>Adding 3D Virtual Content</h3>
            <p>In SceneKit, <a href="https://developer.apple.com/documentation/scenekit/scngeometry">SCNGeometry</a> objects can be attached to the previously-seen SCNNode objects to create realistic visuals. One of the simplest Geometry types is the <a href="https://developer.apple.com/documentation/scenekit/scnbox#relationships">SCNBox</a> object: a "six-sided polyhedron geometry whose whose faces are all rectangles, optionally with rounded edges and corners." Basically, a cube.</p>
            <p>To create a SCNBox, you must define the shape in terms of its width, height, and length. You must then apply the SCNBox to a SCNNode wrapper and place the SCNNode in the sceneView.</p>
            <p>Copy the documented code given below. <b>Carefully study the code, understand what it is doing, and learn from it!</b></p>
            <pre><code>
// Adds a cube to the sceneView at the given position
func addCubeAt(_ position: SCNVector3) {
    // .01 = roughly 10cm
    let cubeGeometry: SCNBox = SCNBox.init(
        width: 0.1, height: 0.1, length: 0.1, chamferRadius: 0)

    // Node that the geometry is applied to
    let cubeNode = SCNNode.init(geometry: cubeGeometry)
    cubeNode.position = position

    // Add the node to the scene
    sceneView.scene.rootNode.addChildNode(cubeNode)

    sceneView.autoenablesDefaultLighting = true
}
            </code></pre>
            <p>Now build and launch your application. Find a horizontal plane, and once it's detected, tap the screen and a cube will appear! </p>
            <div align="center">
                <img src="images/cube-addition.PNG" width="30%" />
            </div>

            <h3>Physics Engine</h3>
            <p>SceneKit includes a realistic physics engine that "performs physics calculations on physics bodies attached to nodes in the scene." To tell SceneKit that it should apply physics to an object, you must attach a <a href="https://developer.apple.com/documentation/scenekit/scnphysicsbody">SCNPhysicsBody</a> to your object.</p>
            <p>Add the following code to your <code>addCubeAt()</code> method.</p>
            <pre><code>
// Add Physics Body to the cube
let physicsBody: SCNPhysicsBody = SCNPhysicsBody(type: SCNPhysicsBodyType.dynamic, shape: nil)
physicsBody.mass = 1.0; // 1kg
cubeNode.physicsBody = physicsBody
            </code></pre>

            <h2>TODO ADD IMAGE</h2>
            <p>Now your cubes will obey gravity and collide with your planes!</p>

        </div>
    </div>

    <div id="sidebar"></div>
</div>

<!-- Scripts -->
<script src="../../assets/js/jquery.min.js"></script>
<script src="../../assets/js/skel.min.js"></script>
<script src="../../assets/js/util.js"></script>
<!--[if lte IE 8]>
<script src="../../assets/js/ie/respond.min.js"></script><![endif]-->
<script src="../../assets/js/main.js"></script>

<script src="../../assets/js/main.js"></script>
<!-- Load sidebar from server -->
<script>
    $(function () {
        $("#sidebar").load("../../template/sidebar.html");
    })

    $(document).ready(function () {
        $('pre code').each(function (i, block) {
            hljs.highlightBlock(block);
        });
    });
</script>

</body>
</html>